<!DOCTYPE html>
<html>
  <head>
    <title>extrudepolygon-provinces</title>
    <script type="text/javascript" src="https://unpkg.com/dat.gui@0.7.6/build/dat.gui.min.js"></script>
    <link type="text/css" rel="stylesheet" href="https://unpkg.com/maptalks/dist/maptalks.css" />
    <script type="text/javascript" src="https://unpkg.com/maptalks/dist/maptalks.js"></script>
    <script type="text/javascript" src="https://unpkg.com/@maptalks/gl/dist/maptalksgl.js"></script>
    <script type="text/javascript" src="https://unpkg.com/three@0.138.0/build/three.min.js"></script>
    <script type="text/javascript" src="https://unpkg.com/three@0.138.0/examples/js/libs/stats.min.js"></script>
    <script type="text/javascript" src="https://unpkg.com/maptalks.three@latest/dist/maptalks.three.js"></script>
    <style>
      html,
      body {
        margin: 0px;
        height: 100%;
        width: 100%;
      }

      #map {
        width: 100%;
        height: 100%;
        background-color: #000;
      }
    </style>
  </head>

  <body>
    <div id="map"></div>
    <script>
    
      //////
      var map = new maptalks.Map('map', {
        center: [109.02177505847749, 32.15109908207964],
        zoom: 4.478337137999542,
        pitch: 42.79999999999998,
        bearing: 0.9000000000005457,
        // bearing: 180,
        centerCross: true,
        doubleClickZoom: false,
        baseLayer: new maptalks.TileLayer('base', {
          urlTemplate: 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png',
          subdomains: ['a', 'b', 'c', 'd'],
          attribution:
            '&copy; <a href="http://osm.org">OpenStreetMap</a> contributors, &copy; <a href="https://carto.com/">CARTO</a>'
        })
      })

      // the ThreeLayer to draw buildings
      var threeLayer = new maptalks.ThreeLayer('t', {
        // geometryEvents: true,
        forceRenderOnMoving: true,
        forceRenderOnRotating: true
        // animation: true
      })
      threeLayer.prepareToDraw = function (gl, scene, camera) {
        stats = new Stats()
        stats.domElement.style.zIndex = 100
        document.getElementById('map').appendChild(stats.domElement)

        var light = new THREE.DirectionalLight(0xffffff)
        light.position.set(0, -10, 10).normalize()
        scene.add(light)

        scene.add(new THREE.AmbientLight(0xffffff, 0.2))

        camera.add(new THREE.PointLight(0xffffff, 1))
        fetch('./components/json/sichuan.json')
          .then((res) => res.json())
          .then((geojson) => {
            addExtrudePolygon(geojson)
          })
      }
      const sceneConfig = {
        postProcess: {
          enable: true,
          antialias: { enable: true },
          bloom: {
            enable: true,
            factor: 0.3 // 辉光强度
          }
        }
      }
      const groupLayer = new maptalks.GroupGLLayer('group', [threeLayer], { sceneConfig })
      groupLayer.addTo(map)

      var extrudepolygons = []
      const material = new THREE.MeshBasicMaterial({ transparent: true, opacity: 0.1, color: 'rgba(9, 214, 232)' })
      const highlightmaterial = new THREE.MeshPhongMaterial({ transparent: true, opacity: 0.8 })
      const lineMaterial = new THREE.LineBasicMaterial({
        linewidth: 2,
        color: 'rgba(9, 214, 232)',
        transparent: true,
        opacity: 1
      })
      const flyCurveLine = initLineMaterial()

      function addExtrudePolygon(geojson) {
        let idx = 0
        geojson.features.slice(0, Infinity).forEach((f) => {
          const lineStrings = []
          const geometry = f.geometry
          if (geometry.type === 'MultiPolygon') {
            geometry.coordinates.forEach((coordinates) => {
              lineStrings.push(new maptalks.LineString(coordinates[0]))
            })
          } else {
            lineStrings.push(new maptalks.LineString(geometry.coordinates[0]))
          }
          const polygon = threeLayer.toExtrudePolygon(f, { height: 20000, interactive: false, bloom: true }, material)
          //event test
          ;['mouseover', 'mouseout'].forEach(function (eventType) {
            polygon.on(eventType, function (e) {
              if (e.type === 'mouseout') {
                this.setSymbol(material)
              }
              if (e.type === 'mouseover') {
                this.setSymbol(highlightmaterial)
              }
            })
          })
          extrudepolygons.push(polygon)
          lineStrings.forEach((lineString) => {
            const line = threeLayer.toLine(
              lineString,
              { altitude: 20000 * 1.0001, interactive: false, bloom: true },
              lineMaterial
            )
            ;['click', 'mouseout', 'mouseover', 'mousedown', 'mouseup', 'dblclick', 'contextmenu'].forEach(function (
              eventType
            ) {
              line.on(eventType, function (e) {
                console.log(e.type, e)
                // console.log(this);
                if (e.type === 'mouseout') {
                  this.setSymbol(material)
                }
                if (e.type === 'mouseover') {
                  this.setSymbol(highlightmaterial)
                }
              })
            })
            extrudepolygons.push(line)
          })
          idx++
        })

        threeLayer.addMesh(extrudepolygons)

        animation()
      }

      function animation() {
        // layer animation support Skipping frames
        threeLayer._needsUpdate = !threeLayer._needsUpdate
        if (threeLayer._needsUpdate) {
          threeLayer.redraw()
        }
        stats.update()
        requestAnimationFrame(animation)
      }

      map.on('click', (e) => {
        map.identify(
          {
            coordinate: e.coordinate,
            layers: [threeLayer]
          },
          (geos) => {
            console.log(geos)
          }
        )
        // const data = threeLayer.identify(e.coordinate)
        // if (data.length === 0) {
        //   console.log('No Data')
        // } else {
        //   console.log(JSON.stringify(data))
        // }
      })
    </script>
  </body>
</html>
